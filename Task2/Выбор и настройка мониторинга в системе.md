# Мотивация

Из-за отсутствия мониторинга системы бизнес не видит - где "застревают" заказы, какие сервисы перегружены и где происходят ошибки. По этому компания получает негативные отзывы и теряет клиентов, в то время как производственные мощности простаивают.
Внедрение мониторинга позволит видеть текущее состояние системы, быстро реагировать на проблемы и оптимизировать работу сервисов. Принимать обоснованное решение по развитию инфраструктуры и масштабированию сервисов. Что в свою очередь позволит улучшить качество API и внутренних сервисов, повысить скорость доставки заказов до производства, повысить удовлетворенность клиентов и снизить количество негативных отзывов.

# Выбор подхода к мониторингу

В разных частях системы будут использоваться разные подходы к мониторингу:

1. API и фронтенды - подход RED
   Потому, что это позволяет быстро выявлять проблемы в работе API и фронтендов, а также получать информацию о производительности и доступности сервисов.
2. Базы данных, очереди и кэши - подход USE
   Потому, что это позволяет выявлять проблемы с производительностью и доступностью баз данных, очередей и кэшей, а также оптимизировать их работу.
3. Бизнес-метрики - "Четыре золотых сигнала"
   Потому, что это позволяет видеть текущее состояние системы, быстро реагировать на проблемы и оптимизировать работу сервисов. А также принимать обоснованное решение по развитию инфраструктуры и масштабированию сервисов

# Выбор метрик

| Метрика                                                          | Зачем нужна                                                       | Ярлыки                     |
| ---------------------------------------------------------------- | ----------------------------------------------------------------- | -------------------------- |
| dead-letter-exchange                                             | Показывает ошибки доставки, возможные сбои в интеграции MES и CRM | имя очереди, тип сообщения |
| flight                                                           | Позволяет оценить перегрузку и задержки обработки                 | имя очереди                |
| Number of requests (RPS)                                         | Определяет нагрузку на каждый сервис                              | метод, endpoint            |
| Number of HTTP 500                                               | Явный индикатор проблем, сбоев                                    | метод, endpoint            |
| Response time (latency)                                          | Позволяет находить деградацию производительности                  | метод, endpoint            |
| CPU % и Memory Utilisation                                       | Диагностика ресурсоёмких компонентов                              | сервис                     |
| Memory Utilisation for db                                        | База может перегружаться или кэшироваться плохо                   | имя базы                   |
| Number of connections for db                                     | Указывает на проблемы в пуле соединений или утечки                | приложение                 |
| Время между `SUBMITTED` и `PRICE_CALCULATED`                     | Показывает, насколько быстро система обрабатывает 3D-модели       | id заказа                  |
| Кол-во заказов в статусе `MANUFACTURING_APPROVED`, старше 7 дней | Сигнал об «застревании» заказов                                   | id заказа                  |
| Среднее время в статусах                                         | Обнаруживает «узкие места» в цепочке                              | статус                     |

# План действий

1. Выбор стека технологий мониторинга
2. DevOps. Создать time-series базу данных (Prometheus или аналог)
3. Разработчики. Интеграция метрик в каждый сервис:
   - Java Spring Boot
   - C# (MES)
   - RabbitMQ
4. Развернуть дашборды:
   - Для API (RED-модель).
   - Для RabbitMQ (USE-модель)
   - Для бизнес-процессов (custom дашборд по статусам заказов)
5. Настроить алертинг:
   - Срабатывание на HTTP 500
   - перегрузку
   - dead-letter
6. Документировать метрики и пороговые значения

# Показатели насыщенности

| Показатель                                              | Почему важно                   | Действие                           |
| ------------------------------------------------------- | ------------------------------ | ---------------------------------- |
| Number of dead-letter > 10 за 5 минут                   | Проблемы с доставкой сообщений | Оповещение + тикет Dev             |
| Latency > 3 сек (shop API)                              | Замедление UX                  | Оповещение + анализ логов          |
| CPU > 80% дольше 5 минут                                | Потенциальная перегрузка       | Добавить инстанс / масштабировать  |
| Заказ в статусе `MANUFACTURING_APPROVED` > 7 дней       | Заказ «завис»                  | Добавить в дашборд + уведомить CRM |
| Время между `SUBMITTED` и `PRICE_CALCULATED` > 20 минут | Задержка обработки 3d-модели   | Оповещение                         |
